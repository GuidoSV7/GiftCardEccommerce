<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Debug Completo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        input { padding: 8px; margin: 5px; width: 300px; }
        #logs { height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background-color: #f8f9fa; font-family: monospace; font-size: 12px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß WebSocket Debug Completo</h1>
        
        <div class="section">
            <h3>1. Test de Conectividad HTTP</h3>
            <button onclick="testHttpConnection()">Probar API REST</button>
            <div id="http-result"></div>
        </div>

        <div class="section">
            <h3>2. Test de WebSocket B√°sico</h3>
            <button onclick="testWebSocketBasic()">Probar WebSocket</button>
            <div id="ws-basic-result"></div>
        </div>

        <div class="section">
            <h3>3. Test de WebSocket con Autenticaci√≥n</h3>
            <input type="text" id="tokenInput" placeholder="Token JWT" />
            <button onclick="testWebSocketAuth()">Probar con Token</button>
            <div id="ws-auth-result"></div>
        </div>

        <div class="section">
            <h3>4. Test de Socket.IO</h3>
            <input type="text" id="socketTokenInput" placeholder="Token JWT" />
            <button onclick="testSocketIO()">Probar Socket.IO</button>
            <div id="socketio-result"></div>
        </div>

        <div class="section">
            <h3>5. Logs Detallados</h3>
            <button onclick="clearLogs()">Limpiar Logs</button>
            <div id="logs"></div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        function addLog(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> <span style="color: ${type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#17a2b8'}">${message}</span>`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function setResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="test-result ${type}">${message}</div>`;
        }

        // 1. Test de Conectividad HTTP
        async function testHttpConnection() {
            addLog('üîÑ Probando conectividad HTTP...');
            
            try {
                const response = await fetch('https://api.digitalstream.es/api/chat/session/active', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    addLog('‚úÖ API REST responde correctamente', 'success');
                    setResult('http-result', '‚úÖ API REST funcionando', 'success');
                } else {
                    addLog(`‚ö†Ô∏è API REST responde con status: ${response.status}`, 'warning');
                    setResult('http-result', `‚ö†Ô∏è Status: ${response.status}`, 'warning');
                }
            } catch (error) {
                addLog(`‚ùå Error en API REST: ${error.message}`, 'error');
                setResult('http-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // 2. Test de WebSocket B√°sico
        function testWebSocketBasic() {
            addLog('üîÑ Probando WebSocket b√°sico...');
            
            try {
                const ws = new WebSocket('wss://api.digitalstream.es/chat');
                
                ws.onopen = function(event) {
                    addLog('‚úÖ WebSocket b√°sico conectado', 'success');
                    setResult('ws-basic-result', '‚úÖ WebSocket b√°sico funciona', 'success');
                    ws.close();
                };
                
                ws.onerror = function(error) {
                    addLog('‚ùå Error en WebSocket b√°sico', 'error');
                    setResult('ws-basic-result', '‚ùå WebSocket b√°sico falla', 'error');
                };
                
                ws.onclose = function(event) {
                    addLog(`üîå WebSocket b√°sico cerrado: ${event.code} - ${event.reason}`);
                };
                
            } catch (error) {
                addLog(`‚ùå Error creando WebSocket: ${error.message}`, 'error');
                setResult('ws-basic-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // 3. Test de WebSocket con Autenticaci√≥n
        function testWebSocketAuth() {
            const token = document.getElementById('tokenInput').value;
            if (!token) {
                addLog('‚ö†Ô∏è Ingresa un token JWT', 'warning');
                return;
            }

            addLog('üîÑ Probando WebSocket con autenticaci√≥n...');
            
            try {
                const ws = new WebSocket('wss://api.digitalstream.es/chat');
                
                ws.onopen = function(event) {
                    addLog('‚úÖ WebSocket con auth conectado', 'success');
                    addLog('üîê Enviando token de autenticaci√≥n...');
                    
                    // Enviar token (esto es lo que hace Socket.IO autom√°ticamente)
                    ws.send(JSON.stringify({
                        type: 'auth',
                        token: token
                    }));
                    
                    setResult('ws-auth-result', '‚úÖ WebSocket con auth funciona', 'success');
                    ws.close();
                };
                
                ws.onmessage = function(event) {
                    addLog(`üì® Mensaje recibido: ${event.data}`);
                };
                
                ws.onerror = function(error) {
                    addLog('‚ùå Error en WebSocket con auth', 'error');
                    setResult('ws-auth-result', '‚ùå WebSocket con auth falla', 'error');
                };
                
                ws.onclose = function(event) {
                    addLog(`üîå WebSocket con auth cerrado: ${event.code} - ${event.reason}`);
                };
                
            } catch (error) {
                addLog(`‚ùå Error creando WebSocket con auth: ${error.message}`, 'error');
                setResult('ws-auth-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // 4. Test de Socket.IO
        function testSocketIO() {
            const token = document.getElementById('socketTokenInput').value;
            if (!token) {
                addLog('‚ö†Ô∏è Ingresa un token JWT', 'warning');
                return;
            }

            addLog('üîÑ Probando Socket.IO...');
            
            try {
                const socket = io('https://api.digitalstream.es/chat', {
                    auth: {
                        token: token
                    },
                    transports: ['websocket', 'polling'],
                    timeout: 5000
                });
                
                socket.on('connect', () => {
                    addLog('‚úÖ Socket.IO conectado exitosamente', 'success');
                    setResult('socketio-result', '‚úÖ Socket.IO funciona', 'success');
                    socket.disconnect();
                });
                
                socket.on('connected', (data) => {
                    addLog(`üì® Socket.IO autenticado: ${JSON.stringify(data)}`);
                });
                
                socket.on('connect_error', (error) => {
                    addLog(`‚ùå Error de conexi√≥n Socket.IO: ${error.message}`, 'error');
                    setResult('socketio-result', `‚ùå Error: ${error.message}`, 'error');
                });
                
                socket.on('disconnect', (reason) => {
                    addLog(`üîå Socket.IO desconectado: ${reason}`);
                });
                
            } catch (error) {
                addLog(`‚ùå Error creando Socket.IO: ${error.message}`, 'error');
                setResult('socketio-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Auto-test al cargar
        addLog('üöÄ Debug WebSocket iniciado');
        addLog('üí° Ejecuta los tests en orden para diagnosticar el problema');
    </script>
</body>
</html>
